---
title: 2018-3-20相机
tags: Roger, Android, 小书匠
grammar_cjkRuby: true
---


欢迎使用 **{小书匠}(xiao shu jiang)编辑器**，您可以通过 `小书匠主按钮>模板` 里的模板管理来改变新建文章的内容。

# 相机配置参数
## Yota相机的参数Parameters
Android打开相机Camera.open时会获取参数
在AndroidCameraAgentImpl
```java
public void handleMessage(final Message msg) {
            super.handleMessage(msg);
            int cameraAction = msg.what;

            // CameraState will reset in OPEN_CAMERA,  so ignore invalid state in OPEN_CAMERA.
            if (getCameraState().isInvalid() && cameraAction != CameraActions.OPEN_CAMERA) {
                Log.i(TAG, "Skip handleMessage - action = '" + CameraActions.stringify(msg.what) + "'");
                return;
            }
            Log.i(TAG, "handleMessage - action = '" + CameraActions.stringify(msg.what) + "'");

            try {
                switch (cameraAction) {
                    case CameraActions.OPEN_CAMERA: {
                        final CameraOpenCallback openCallback = (CameraOpenCallback) msg.obj;
                        final int cameraId = msg.arg1;
                        if (mCameraState.getState() != AndroidCameraStateHolder.CAMERA_UNOPENED) {
                            openCallback.onDeviceOpenedAlready(cameraId, generateHistoryString(cameraId));
                            break;
                        }

                        Log.i(TAG, "Opening camera " + cameraId + " with camera1 API");
                        mCamera = android.hardware.Camera.open(cameraId);
                        if (mCamera != null) {
                            mCameraId = cameraId;
                            mParameterCache = new ParametersCache(mCamera);
                            //Get origin parameter to reset camera parameter when camera is reconnected
                            Camera.Parameters param = mParameterCache.getBlocking();
                            if(param != null){
                                CameraFactory.getPlatformCamera().setZsAlgo20defaultParameter(param);
                                mOriginParameter = Camera.getParametersCopy(param);
                            }else {
                                Log.e(TAG,"error param == null");
                            }

                            mCharacteristics =
                                    AndroidCameraDeviceInfo.create().getCharacteristics(cameraId);
                            mCapabilities = new AndroidCameraCapabilities(
                                    mParameterCache.getBlocking());

                            mCamera.setErrorCallback(this);

                            // validate camera state because camera opened success.
                            mCameraState.validate();
                            mCameraState.setState(AndroidCameraStateHolder.CAMERA_IDLE);
                            if (openCallback != null) {
                                mCameraProxy = new AndroidCameraProxyImpl(
                                        mAgent, cameraId, mCamera, mCharacteristics, mCapabilities);
                                openCallback.onCameraOpened(mCameraProxy);
                            }
                        } else {
                            if (openCallback != null) {
                                openCallback.onDeviceOpenFailure(cameraId, generateHistoryString(cameraId));
                            }
                        }
                        break;
                    }
```

applySettingsToParameters()方法将设置变成相机的属性参数其中包括:
: setPreviewFormat()
: setJpegQuality
: setZoom 缩放
: setExposureCompensation 
: 等等
### CameraSettings将设置转换为参数Parameters

## PlatformCamera
PlatformCamera.setZsAlgo20defaultParameter()
ZS去设置一些参数,如美颜级别

如果想要修改那个属性，使用set方法，比如设置缩放
```java
if(parameters.isZoomSupported()){  
     //tenDesiredZoom取值在parameters.getMinZoom()与parameters.getMaxZoom()之间       
      parameters.set("zoom", String.valueOf(tenDesiredZoom));  
} 
```
想要获取设置的属性值就更简单了，直接调用下面的方法就搞定了：
```
parameters.get(String key);
```
## Parameters
下面列表中，等号前面的就是key值，后面就是对应属性值value：
``` java
class Camera {
	class Parameters{
		setPreviewFpsRange(min,max); //	预览照片时每秒显示帧数的最小值和最大值  key = preview-fps-range, value=min, max  "preview-fps-range-values" -> "(15000,15000),(20000,20000),(7500,24000),(24000,24000),(7000,30000),(30000,30000),(15000,30000)" 该值是帧率*1000 其中Y3是7000,30000
		setAntibanding(String antibanding) ;//设置屏幕刷新率,来降低条带效果 key= antibanding, 
		getSupportedAntibanding(); //获取可支持的屏幕刷新率 off,50hz,60hz,auto
		getSupportedPictureSizes();//获取可支持的图片大小 key=picture-size-values, "4032x3024,4000x3000,3840x2160,3264x2448,3264x1836,3200x2400,2592x1944,2688x1512,2048x1536,1920x1080,1440x1080,1280x960,1280x720,640x480,352x288,320x240,176x144"
		getMaxNumDetectedFaces();//获取能检测的最大人脸数量 key=max-num-detected-faces-hw, Y3的IMX386 值为10
		startFaceDetection();//开启人脸检测
	}
}



flatten:   
snapshot-picture-flip = off flip-v flip-h; 
//镜像模式: 当旋转 (rotation == 90 || rotation == 270)垂直翻转

jpeg-watermark = 0,1; 
//自动水印 mAutoWaterMarkEnable == false) ? 0 : 1; 0为关闭,1为打开 

picture-size=4160x3120;  //图片大小
picture-size-values=4128x3088,4128x2320,4160x3120,4160x2340 

preview-size   //预览大小

Anti-Flicker

capture-burst-interval-max=10;  
mirror-enable=0;  //镜像模式
zoom=31;  
redeye-reduction-values=enable,disable;  
max-num-detected-faces-hw=4;  
scene-detect-values=off,on;  
qc-camera-features=1;  
face-detection-values=off,on;  
cap-mode=normal;  
whitebalance=auto;  
max-sharpness=30;  
asd-mode=auto;  
preview-format-values=yuv420sp,yuv420sp-adreno,yuv420p,yuv420p,nv12;jpeg-thumbnail-quality=90;  
preview-format=yuv420sp;  
face-detection=off;  
video-hdr-values=off,on;  
camera-mode-values=0,1;  
auto-exposure-values=frame-average,center-weighted,spot-metering;
snapshot-flip=0;  
video-zoom-support=true;  
iso=auto;mce-values=enable,disable;  
video-hdr=off;  
flash-mode-values=off,auto,on,torch;  
preview-frame-rate=30;  
fb-smooting=90;  
jpeg-thumbnail-width=512;  
video-size=1920x1080;  
scene-mode-values=auto,asd,action,portrait,landscape,night,night-portrait,theatre,beach,snow,sunset,steadyphoto,fireworks,sports,party,candlelight,backlight,flowers,AR,hdr,macro,mix-illuminant,indoor;  
redeye-reduction=disable;  
preview-fps-range-values=(7577,30082);  
auto-exposure=frame-average;  
histogram=disable;  
fb-eye-enlargement=90;  
camera-mode=1;  
preview-size-values=1920x1080,1440x1080,1280x720,800x480,720x480,640x480,352x288,320x240,240x160,192x112,176x144;  
raw-size=4032x3024; //实际 原料 大小
touch-af-aec=touch-off;  
preview-fps-range=7577,30082;  
auto-whitebalance-lock=false;  
min-exposure-compensation=-12;  
antibanding=off;  
max-num-focus-areas=1;  
vertical-view-angle=48.3;  
display_mode=portrait;  
qc-max-num-requested-faces=2;  
capture-burst-exposures-values=-12,-11,-10,-9,-8,-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,11,12;  //曝光
slow-shutter=slow-shutter-off;max-saturation=10;capture-burst-interval-min=1;  
no-display-mode=0;max-contrast=10;  
slow-shutter-values=slow-shutter-off,slow-shutter-auto,slow-shutter-1/2s,slow-shutter-1s,slow-shutter-2s,slow-shutter-4s,slow-shutter-8s;  
picture-format-values=jpeg,raw;video-hfr=off;exposure-compensation-step=0.166667;  
scene-detect=off;  //场景侦测
saturation=5;  
fb-face-slimming=71;  
whitebalance-values=auto,incandescent,fluorescent,daylight,cloudy-daylight;  
picture-format=jpeg;zsl=off;  
reduce-purple=off;  
lensshade-values=enable,disable;  
selectable-zone-af=auto;  
video-hfr-values=off,60,90,120;  //视频High frame rate高帧率
iso-values=auto,ISO_HJR,ISO100,ISO200,ISO400,ISO800,ISO1600;  
selectable-zone-af-values=auto,spot-metering,center-weighted,frame-average;  
lensshade=enable;  
capture-burst-exposures=;  
preferred-preview-size-for-video=1920x1080;  
intelligent-mode=0;mce=enable;  
hfr-size-values=800x480,640x480;  
zoom-supported=true;  
strtextures=OFF;  
face-beautify=0;  
denoise-values=denoise-off,denoise-on;zsl-values=off,on;sharpness=10;  
contrast=5;  
scene-mode=auto;  
jpeg-quality=85;  
capture-burst-interval=1;  
video-skinbeauty-mode=off;  
histogram-values=enable,disable;  
overlay-format=265;metering-areas=(0,0,80,80,1000);  
capture-burst-captures-values=3;  
ideo-size-values=1920x1080,1280x1088,1280x720,800x480,720x480,640x480,480x320,352x288,320x240,192x112,176x144;skinToneEnhancement=0;fb-toning=90;  
preview-size=1440x1080;focal-length=3.85;  
ae-bracket-hdr-values=Off,HDR,AE-Bracket;  
denoise=denoise-off;capture-burst-retroactive=0;  
video-flip=0;  
preview-frame-rate-values=5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120;  //预览帧率
power-mode-supported=true;  
max-num-metering-areas=1;  
face_position=(-1,-1);  
preview-flip=0;  //预览翻转 off on
focus-mode-values=auto,infinity,normal,macro,continuous-picture,continuous-video;  
action-mode=all;  
power-mode=Normal_Power;  
jpeg-thumbnail-size-values=512x288,480x288,432x288,512x384,352x288,320x240,192x112,176x144,0x0;  
zoom-ratios=100,102,104,107,109,112,114,117,120,123,125,128,131,135,138,141,144,148,151,155,158,162,166,170,174,178,182,186,190,195,200,204,209,214,219,224,229,235,240,246,251,257,263,270,276,282,289,296,303,310,317,324,332,340,348,356,364,373,381,390;  
single-isp-output-enabled=false;  
 
```
# 相机设置尺寸
## 关键类和布局
Class类
: CameraSettingActivity, 
: CameraSettingsActivity, 
: CameraSettings,
: PhotoModuleExtend, 

res资源文件
: camera_preferences_zs.xml  设置的列表布局
![enter description here][1]

后置相机分辨率尺寸的camera_preferences_zs.xml代码
```xml
    <!-- BACK camera PHOTO resolution -->
    <ListPreference
        android:defaultValue="@string/pref_camera_picturesize_default"
        android:entryValues="@array/pref_camera_picturesize_entryvalues"
        android:key="pref_camera_picturesize_back_key"
        android:negativeButtonText="@null"
        android:positiveButtonText="@null"
        android:title="@string/setting_back_camera_photo"/>
```
在com.android.camera.settings.Keys中
```java
    public static final String KEY_PICTURE_SIZE_BACK = "pref_camera_picturesize_back_key";
```
在CameraSettingsActivity的setEntries(Preference preference)方法中
```java
ListPreference listPreference = (ListPreference) preference;
if (listPreference.getKey().equals(Keys.KEY_PICTURE_SIZE_BACK)) {
          setEntriesForSelection(mPictureSizes.backCameraSizes, listPreference);
}
```
在返回相机首页时,会调用com.android.camera.settings.ResolutionSetting.getPictureSize()方法
```java
final String pictureSizeSettingKey = cameraFacing == OneCamera.Facing.FRONT ?
Keys.KEY_PICTURE_SIZE_FRONT : Keys.KEY_PICTURE_SIZE_BACK;
		...
pictureSize = SettingsUtil.sizeFromSettingString(
mSettingsManager.getString(SettingsManager.SCOPE_GLOBAL,
pictureSizeSettingKey));

```
### 4:3时
启动相机或进入相机预览界面 都会调用 AndroidCameraAgentImpl的CameraHandler.handleMessage 
CameraActions.APPLY_SETTINGS

AndroidCameraSettings
mCurrentPhotoSize = Size: (4032 x 3024)
mCurrentPreviewSize = Size: (1440 x 1080)
### 16:9时
AndroidCameraSettings
mCurrentPhotoSize = Size: (3840 x 2160)
mCurrentPreviewSize = Size: (1920 x 1080)

## 时序图
```plantuml!
@startuml
title 设置修改尺寸时序图
hide footbox
PhotoModule -> PhotoModule : startPreview
PhotoModule -> AndroidCameraAgentImpl : updateParametersPictureSize
AndroidCameraAgentImpl -> CameraAgent : applySettings
CameraAgent -> AndroidCameraAgentImpl : applySettingsHelper
AndroidCameraAgentImpl --> Camera : CameraHandle.handleMessage
```

ResolutionUtil. getDisplayableSizesFromSupported
从17种可用的尺寸中选出2种最大的4:3和16:9

List<ResolutionBucket> buckets 
 : aspectRatio = 1.3333334  4:3  4160x3120
 : aspectRatio = 1.77777778 16:9  3840x2160
 : aspectRatio

## 总结
如果要改成**18:9**的话,需要将aspectRatio的值改成2,底层需要支持的photo-size 也要相应的修改

# 适配(全面屏18:9)
## 资源适配
### 声明最大高宽比
在应用配置文件AndroidManifest.xml中显式声明支持的最大屏幕高宽比（maximum aspect ratio）。其中 ratio_float 为高宽比：
传统屏幕：ratio_float = 16/9 = 1.778 ；
T6屏幕 : ratio_float = 18/9  = 2;
三星S8屏幕：ratio_float = 18.5/9 = 2.056。
鉴于目前全面屏屏幕比例，将ratio_float设置为2.1即可适配一众全面屏手机。
```xml
<meta-data 
  android:name="android.max_aspect"
  android:value="ratio_float" />
```
然而有一点需要注意的是，在Android 7.0以上Google默认支持了分屏模式，即Manifest文件中配置Activity的android:resizeableActivity默认属性为true，在这种情况下并不需要配置Maximum Aspect Ratio即可自动适配全面屏。

如果从来没有处理过 android.max_aspect，也没有设置 android:resizeableActivity为true。那么你的应用在某些手机中，就会出现上下黑边的情况

### 图片适配
考虑到目前大部分全面屏手机只是在高度上拉长，且大多为6.0英寸左右，像素密度对比xxhdpi并没有多大区别，那我们可以在项目中增加一组资源drawable-xxhdpi-2160x1080 、drawable-long 这样解决图片的拉伸问题，当然最好的方法还是用相对布局采用XML的方式,或者.9图的解决方案。

## 代码适配
### 判断机型适配

```java
Log.d(TAG, "onCreate: ----------------------------180326");
String DeviceName = android.os.Build.DEVICE;
Log.d(TAG, "onCreate:----------180326 DeviceName = " + DeviceName);
```

03-26 10:42:17.838 11609-11609/com.roger.demo4roger D/Main: onCreate: ----------------------------180326
03-26 10:42:17.838 11609-11609/com.roger.demo4roger D/Main: onCreate:----------180326 DeviceName = T6


03-26 10:40:51.338 28478-28478/com.roger.demo4roger D/Main: onCreate: ----------------------------180326
03-26 10:40:51.338 28478-28478/com.roger.demo4roger D/Main: onCreate:----------180326 DeviceName = Y3

## 思考
1. 还有其他更好的适配方案吗?大家可以讨论一下
2. 

# T6拍照完卡住的Bug
## 分析
猜测:拍完照没有回调,导致没有startPreview()
通过Y3和T6的相机调试打断点,发现基本一致
当断点到T6的Parameters时,size为79-80个
而Y3 size有200-209个,应该是Framework层的Camera相关代码没有移植完导致的

# 录像的流程
## 时序图
```plantuml!
@startuml
title 录像流程时序图
hide footbox
autonumber 1
== 点击录像按钮 ==
ShutterBuuton -> VideoModule : performClick
VideoModule -> VideoModule : onShutterButtonClick
VideoModule -> MediaRecorder : startVideoRecording
== 点击切换摄像头 ==
autonumber 1
ButtonManager -> ButtonCallback : setPreChangeCallback
ButtonCallback -> VideoModule : onStateChanged
VideoModule -> SettingsManager : switchCamera
```

在com.android.camera.VideoModule.**startVideoRecording**方法主要开启录像和隐藏/显示一些图标
```java
mMediaRecorder.start(); // Recording is now started

mAppController.getCameraAppUI().hideModeOptions();
mAppController.getCameraAppUI().animateBottomBarToVideoStop(getVideoStopDrawable());
mUI.showRecordingUI(true);

```


  [1]: ./images/CameraSettings.png "CameraSettings"